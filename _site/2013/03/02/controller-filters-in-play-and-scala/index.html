<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Controller filters in Play and Scala &middot; will chan's random blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="layout-reverse">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>I'm a software engineer working at <a href="http://www.paxata.com/">Paxata</a>. I write about random things here.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
  </nav>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="https://github.com/williamchan">github</a>
  </nav>
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="https://www.linkedin.com/in/williamchan">linkedin</a>
  </nav>
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="https://twitter.com/w1zz1e">twitter</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59151560-1', 'williamchan.github.io');
  ga('send', 'pageview');

</script>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">will chan's random blog</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Controller filters in Play and Scala</h1>
  <span class="post-date">02 Mar 2013</span>
  <p>We were chilling with other students enrolled in the coursera Scala class wondering aloud why one would ever use <a href="https://en.wikipedia.org/wiki/Currying">currying</a>. Admittedly, the ability to organize parameter lists for your functions feels somewhat academic, but we have managed to use function currying in ways that we’re really happy with.</p>

<p>In our web app, we have many controllers that respond to different kinds of requests. Some of those controllers respond to simple GET requests that are not expected to alter state on the server. Some respond to POST requests that are expected to change state and also check CSRF tokens. And some other controllers respond to POST requests to Api endpoints for which CSRF tokens are not relevant.</p>

<p>We have a class called ControllerMethod that is flexible enough to handle these general types of requests whether GET or POST or Api POST, and yet can be tailored with the specific logic that should execute for that route.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">class</span> <span class="nx">ControllerMethod</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">def</span> <span class="nx">apply</span><span class="p">[</span><span class="nx">A</span><span class="p">](</span><span class="nx">dbSettings</span><span class="o">:</span> <span class="nx">ControllerDBSettings</span> <span class="o">=</span> <span class="nx">WithoutDBConnection</span><span class="p">)</span>
              <span class="p">(</span><span class="nx">action</span><span class="o">:</span> <span class="nx">Action</span><span class="p">[</span><span class="nx">A</span><span class="p">])</span><span class="o">:</span> <span class="nx">Action</span><span class="p">[</span><span class="nx">A</span><span class="p">]</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="nx">Action</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">parser</span><span class="p">)</span> <span class="p">{</span> <span class="nx">request</span> <span class="o">=&gt;</span>
      <span class="nx">dbSettings</span> <span class="nx">match</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">WithoutDBConnection</span> <span class="o">=&gt;</span> <span class="nx">action</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
          <span class="p">...</span> <span class="nx">other</span> <span class="nx">cases</span> <span class="p">...</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Treating ControllerMethod as a “root method” for controllers, we can use it to streamline our controllers like, for example, the one that returns an egraph:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">def</span> <span class="nx">getEgraph</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span> <span class="nx">Long</span><span class="p">)</span> <span class="o">=</span> <span class="nx">controllerMethod</span> <span class="p">{</span>
  <span class="nx">Action</span> <span class="p">{</span> <span class="nx">implicit</span> <span class="nx">request</span> <span class="o">=&gt;</span>
    <span class="nx">egraphStore</span><span class="p">.</span><span class="nx">findFulfilledEgraph</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="nx">match</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">Some</span><span class="p">(</span><span class="nx">egraph</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Ok</span><span class="p">(</span><span class="nx">renderEgraphPage</span><span class="p">(</span><span class="nx">egraph</span><span class="p">))</span>
      <span class="k">case</span> <span class="nx">None</span> <span class="o">=&gt;</span> <span class="nx">NotFound</span><span class="p">(</span><span class="s2">&quot;No Egraph found&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>This simple pattern eliminates tons of boilerplate code that would otherwise need to be written into each controller. Moreover, the POST controller that handles changes applied to an egraph uses a slightly modified version of controllerMethod. So with minimal variation in code, we treat the POST controller with functionality that you would expect to have, such as a writable database context and protected against CSRF attacks.</p>

<p>Currying is not a technique I envisioned using much when I was first introduced to it. But as we matured as Scala devs and left old Java habits behind, we have used this technique to write dozens of controllers (and other classes) across our web app. Based on experience, currying has proven to be an extremely powerful pattern for bringing organizational sanity to our codebase. =)</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="//2015/07/05/dissecting-big-data/">
            Dissecting the "big data" industry
            <small>05 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="//2015/07/01/ditch-the-annual-review/">
            Ditch the annual review
            <small>01 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="//2015/06/16/elon-musk-biography/">
            Elon Musk biography - on aggressive learning and a fantastic future
            <small>16 Jun 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
